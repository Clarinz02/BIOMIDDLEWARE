#!/usr/bin/env node
/**
 * Enhanced Multi-Device Biometric Server with TypeScript
 * 
 * Features:
 * - Multi-device management with real-time status updates
 * - Role-based access control (RBAC) with JWT authentication
 * - WebSocket real-time communication
 * - Device grouping, templates, and bulk operations
 * - Comprehensive audit logging and security
 * - Advanced monitoring and health checks
 */

import express, { Request, Response, NextFunction } from 'express';
import { createServer } from 'http';
import cors from 'cors';
import helmet from 'helmet';
import compression from 'compression';
import morgan from 'morgan';
import path from 'path';

// Services and Middleware
import { EnhancedDeviceManager } from './services/DeviceManagerService';
import { WebSocketService } from './services/WebSocketService';
import { 
  securityMiddleware, 
  JWTService, 
  PasswordService, 
  AuditLoggerService,
  errorHandler 
} from './middleware/security';

// Types
import { ApiResponse, AuthUser, SystemRole, DeviceConfig } from './types';

// Initialize Express app
const app = express();
const httpServer = createServer(app);
const PORT = process.env.PORT || 3000;

// Initialize services
const deviceManager = new EnhancedDeviceManager('./data');
const jwtService = new JWTService(process.env.JWT_SECRET || 'your-secret-key');
const passwordService = new PasswordService();
const auditLogger = AuditLoggerService.getInstance();

let webSocketService: WebSocketService;

// ===========================================\n// MIDDLEWARE SETUP\n// ===========================================

// Security middleware\napp.use(securityMiddleware.helmet);\napp.use(securityMiddleware.requestId);\napp.use(securityMiddleware.rateLimiter);\n\n// Basic middleware\napp.use(compression());\napp.use(morgan(':remote-addr - :remote-user [:date[clf]] \":method :url HTTP/:http-version\" :status :res[content-length] \":referrer\" \":user-agent\" :response-time ms'));\napp.use(cors({\n  origin: process.env.CORS_ORIGINS?.split(',') || ['http://localhost:3000'],\n  credentials: true,\n  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],\n  allowedHeaders: ['Content-Type', 'Authorization', 'X-API-Key', 'X-Device-ID'],\n}));\n\napp.use(express.json({ limit: '10mb' }));\napp.use(express.urlencoded({ extended: true, limit: '10mb' }));\napp.use(express.static(path.join(__dirname, '../public')));\n\n// ===========================================\n// UTILITY FUNCTIONS\n// ===========================================\n\nconst sendResponse = <T>(\n  res: Response,\n  success: boolean,\n  data?: T,\n  message?: string,\n  statusCode = 200\n): void => {\n  const response: ApiResponse<T> = {\n    success,\n    data,\n    message,\n    meta: {\n      timestamp: new Date().toISOString(),\n      version: '2.0.0',\n      requestId: (res.req as any).requestId,\n    },\n  };\n\n  res.status(statusCode).json(response);\n};\n\nconst asyncHandler = (fn: Function) => {\n  return (req: Request, res: Response, next: NextFunction) => {\n    Promise.resolve(fn(req, res, next)).catch(next);\n  };\n};\n\n// ===========================================\n// AUTHENTICATION ROUTES\n// ===========================================\n\n// Mock user store (in production, use database)\nconst users = new Map<string, {\n  id: string;\n  username: string;\n  email: string;\n  passwordHash: string;\n  role: SystemRole;\n  active: boolean;\n}>(\n  [\n    {\n      id: 'admin-1',\n      username: 'admin',\n      email: 'admin@example.com',\n      passwordHash: '', // Will be set below\n      role: 'super_admin',\n      active: true,\n    },\n  ].map(user => [user.username, user])\n);\n\n// Initialize admin password\npasswordService.hashPassword('admin123').then(hash => {\n  const admin = users.get('admin');\n  if (admin) {\n    admin.passwordHash = hash;\n  }\n});\n\napp.post(\n  '/api/auth/login',\n  securityMiddleware.authRateLimiter,\n  asyncHandler(async (req: Request, res: Response) => {\n    const { username, password } = req.body;\n\n    if (!username || !password) {\n      return sendResponse(res, false, null, 'Username and password required', 400);\n    }\n\n    const user = users.get(username);\n    if (!user || !user.active) {\n      return sendResponse(res, false, null, 'Invalid credentials', 401);\n    }\n\n    const validPassword = await passwordService.verifyPassword(password, user.passwordHash);\n    if (!validPassword) {\n      return sendResponse(res, false, null, 'Invalid credentials', 401);\n    }\n\n    const authUser: AuthUser = {\n      id: user.id,\n      username: user.username,\n      email: user.email,\n      role: user.role,\n      permissions: [], // Would be populated from database\n      active: user.active,\n      createdAt: new Date().toISOString(),\n    };\n\n    const token = jwtService.generateToken(authUser);\n\n    await auditLogger.logAction({\n      userId: user.id,\n      action: 'login',\n      resource: 'auth',\n      details: { username },\n      ipAddress: req.ip || 'unknown',\n      userAgent: req.get('User-Agent') || 'unknown',\n      success: true,\n    });\n\n    sendResponse(res, true, { user: authUser, token }, 'Login successful');\n  })\n);\n\napp.post(\n  '/api/auth/refresh',\n  asyncHandler(async (req: Request, res: Response) => {\n    const { token } = req.body;\n    \n    if (!token) {\n      return sendResponse(res, false, null, 'Token required', 400);\n    }\n\n    try {\n      const newToken = jwtService.refreshToken(token);\n      sendResponse(res, true, { token: newToken }, 'Token refreshed');\n    } catch (error) {\n      sendResponse(res, false, null, 'Invalid token', 401);\n    }\n  })\n);\n\n// ===========================================\n// DEVICE MANAGEMENT ROUTES\n// ===========================================\n\n// System overview\napp.get(\n  '/api/devices',\n  securityMiddleware.authenticate(jwtService),\n  securityMiddleware.authorize('devices', 'read'),\n  securityMiddleware.auditLogger('read', 'devices'),\n  asyncHandler(async (req: Request, res: Response) => {\n    const overview = deviceManager.getSystemOverview();\n    sendResponse(res, true, overview);\n  })\n);\n\n// Add new device\napp.post(\n  '/api/devices',\n  securityMiddleware.authenticate(jwtService),\n  securityMiddleware.authorize('devices', 'create'),\n  securityMiddleware.auditLogger('create', 'devices'),\n  asyncHandler(async (req: Request, res: Response) => {\n    const { deviceId, name, ip, apiKey, useHttps, wifiNetwork, branch, location, autoReconnect, deviceType, capabilities } = req.body;\n    \n    if (!deviceId || !ip) {\n      return sendResponse(res, false, null, 'deviceId and ip are required', 400);\n    }\n    \n    const config = await deviceManager.addDevice(deviceId, {\n      name,\n      ip,\n      apiKey,\n      useHttps: useHttps || false,\n      wifiNetwork,\n      branch: branch || 'main',\n      location,\n      autoReconnect: autoReconnect !== false,\n      deviceType,\n      capabilities,\n    });\n    \n    // Broadcast device addition via WebSocket\n    webSocketService.broadcastSystemAlert({\n      level: 'info',\n      title: 'Device Added',\n      message: `New device ${name} has been added`,\n      deviceId,\n      branch: config.branch,\n    });\n    \n    sendResponse(res, true, config, 'Device added successfully', 201);\n  })\n);\n\n// Connect to device\napp.post(\n  '/api/devices/:deviceId/connect',\n  securityMiddleware.authenticate(jwtService),\n  securityMiddleware.authorize('devices', 'execute'),\n  securityMiddleware.auditLogger('connect', 'devices'),\n  asyncHandler(async (req: Request, res: Response) => {\n    const { deviceId } = req.params;\n    \n    await deviceManager.connectDevice(deviceId);\n    const status = deviceManager.getDeviceStatus(deviceId);\n    \n    // Broadcast status change via WebSocket\n    webSocketService.broadcastDeviceStatus(deviceId, status);\n    \n    sendResponse(res, true, status, `Connected to device: ${deviceId}`);\n  })\n);\n\n// Disconnect from device\napp.post(\n  '/api/devices/:deviceId/disconnect',\n  securityMiddleware.authenticate(jwtService),\n  securityMiddleware.authorize('devices', 'execute'),\n  securityMiddleware.auditLogger('disconnect', 'devices'),\n  asyncHandler(async (req: Request, res: Response) => {\n    const { deviceId } = req.params;\n    \n    await deviceManager.disconnectDevice(deviceId);\n    const status = deviceManager.getDeviceStatus(deviceId);\n    \n    // Broadcast status change via WebSocket\n    webSocketService.broadcastDeviceStatus(deviceId, status);\n    \n    sendResponse(res, true, status, `Disconnected from device: ${deviceId}`);\n  })\n);\n\n// Get specific device status\napp.get(\n  '/api/devices/:deviceId',\n  securityMiddleware.authenticate(jwtService),\n  securityMiddleware.authorize('devices', 'read'),\n  asyncHandler(async (req: Request, res: Response) => {\n    const { deviceId } = req.params;\n    const status = deviceManager.getDeviceStatus(deviceId);\n    \n    if (!status) {\n      return sendResponse(res, false, null, 'Device not found', 404);\n    }\n    \n    sendResponse(res, true, status);\n  })\n);\n\n// Update device configuration\napp.put(\n  '/api/devices/:deviceId',\n  securityMiddleware.authenticate(jwtService),\n  securityMiddleware.authorize('devices', 'update'),\n  securityMiddleware.auditLogger('update', 'devices'),\n  asyncHandler(async (req: Request, res: Response) => {\n    const { deviceId } = req.params;\n    const updates = req.body;\n    \n    const updatedConfig = await deviceManager.updateDeviceConfig(deviceId, updates);\n    \n    sendResponse(res, true, updatedConfig, 'Device configuration updated');\n  })\n);\n\n// Delete device\napp.delete(\n  '/api/devices/:deviceId',\n  securityMiddleware.authenticate(jwtService),\n  securityMiddleware.authorize('devices', 'delete'),\n  securityMiddleware.auditLogger('delete', 'devices'),\n  asyncHandler(async (req: Request, res: Response) => {\n    const { deviceId } = req.params;\n    \n    await deviceManager.removeDevice(deviceId);\n    \n    sendResponse(res, true, null, `Device removed: ${deviceId}`);\n  })\n);\n\n// Test device connection\napp.get(\n  '/api/devices/:deviceId/test',\n  securityMiddleware.authenticate(jwtService),\n  securityMiddleware.authorize('devices', 'read'),\n  asyncHandler(async (req: Request, res: Response) => {\n    const { deviceId } = req.params;\n    \n    const result = await deviceManager.testConnection(deviceId);\n    \n    sendResponse(res, true, result);\n  })\n);\n\n// ===========================================\n// DEVICE OPERATIONS (Multi-Device)\n// ===========================================\n\n// Device information\napp.get(\n  '/api/devices/:deviceId/version',\n  securityMiddleware.authenticate(jwtService),\n  securityMiddleware.authorize('devices', 'read'),\n  asyncHandler(async (req: Request, res: Response) => {\n    const { deviceId } = req.params;\n    const device = deviceManager.getDevice(deviceId);\n    const info = await device.getVersionInfo();\n    sendResponse(res, true, info);\n  })\n);\n\napp.get(\n  '/api/devices/:deviceId/capabilities',\n  securityMiddleware.authenticate(jwtService),\n  securityMiddleware.authorize('devices', 'read'),\n  asyncHandler(async (req: Request, res: Response) => {\n    const { deviceId } = req.params;\n    const device = deviceManager.getDevice(deviceId);\n    const capabilities = await device.getDeviceCapabilities();\n    sendResponse(res, true, capabilities);\n  })\n);\n\n// User management per device\napp.get(\n  '/api/devices/:deviceId/users',\n  securityMiddleware.authenticate(jwtService),\n  securityMiddleware.authorize('users', 'read'),\n  asyncHandler(async (req: Request, res: Response) => {\n    const { deviceId } = req.params;\n    const { position, count } = req.query;\n    \n    const device = deviceManager.getDevice(deviceId);\n    const users = await device.getUsers(\n      position ? parseInt(position as string) : 0,\n      count ? parseInt(count as string) : 100\n    );\n    \n    sendResponse(res, true, users);\n  })\n);\n\n// Attendance records per device\napp.get(\n  '/api/devices/:deviceId/attendance',\n  securityMiddleware.authenticate(jwtService),\n  securityMiddleware.authorize('attendance', 'read'),\n  asyncHandler(async (req: Request, res: Response) => {\n    const { deviceId } = req.params;\n    const { startDate, endDate, position, count } = req.query;\n    \n    const device = deviceManager.getDevice(deviceId);\n    const logs = await device.getAttendanceLogs(\n      startDate as string,\n      endDate as string,\n      position ? parseInt(position as string) : 0,\n      count ? parseInt(count as string) : 100\n    );\n    \n    sendResponse(res, true, logs);\n  })\n);\n\n// ===========================================\n// BULK OPERATIONS\n// ===========================================\n\napp.post(\n  '/api/devices/bulk/connect',\n  securityMiddleware.authenticate(jwtService),\n  securityMiddleware.authorize('devices', 'execute'),\n  securityMiddleware.auditLogger('bulk_connect', 'devices'),\n  asyncHandler(async (req: Request, res: Response) => {\n    const { deviceIds, name = 'Bulk Connect Operation' } = req.body;\n    \n    if (!deviceIds || !Array.isArray(deviceIds)) {\n      return sendResponse(res, false, null, 'deviceIds array is required', 400);\n    }\n    \n    const operationId = await deviceManager.createBulkOperation(\n      name,\n      'connect',\n      deviceIds\n    );\n    \n    sendResponse(res, true, { operationId }, 'Bulk operation started');\n  })\n);\n\napp.get(\n  '/api/devices/bulk/:operationId',\n  securityMiddleware.authenticate(jwtService),\n  securityMiddleware.authorize('devices', 'read'),\n  asyncHandler(async (req: Request, res: Response) => {\n    const { operationId } = req.params;\n    \n    const operation = deviceManager.getBulkOperation(operationId);\n    \n    if (!operation) {\n      return sendResponse(res, false, null, 'Operation not found', 404);\n    }\n    \n    sendResponse(res, true, operation);\n  })\n);\n\n// ===========================================\n// LEGACY COMPATIBILITY ROUTES\n// ===========================================\n\n// Legacy device connection for backward compatibility\napp.post(\n  '/api/device/connect',\n  asyncHandler(async (req: Request, res: Response) => {\n    const { ip, apiKey, useHttps, deviceId } = req.body;\n    const finalDeviceId = deviceId || 'default';\n    \n    try {\n      await deviceManager.addDevice(finalDeviceId, {\n        name: 'Default Device',\n        ip,\n        apiKey,\n        useHttps: useHttps || false,\n      });\n      \n      await deviceManager.connectDevice(finalDeviceId);\n      const status = deviceManager.getDeviceStatus(finalDeviceId);\n      \n      sendResponse(res, true, status, 'Device connection configured');\n    } catch (error) {\n      sendResponse(res, false, null, error.message, 400);\n    }\n  })\n);\n\napp.get(\n  '/api/device/config',\n  asyncHandler(async (req: Request, res: Response) => {\n    const overview = deviceManager.getSystemOverview();\n    const defaultDevice = overview.devices.find(d => d.deviceId === 'default') || overview.devices[0];\n    \n    if (defaultDevice) {\n      sendResponse(res, true, {\n        config: {\n          ip: defaultDevice.ip,\n          apiKey: 'configured',\n          useHttps: false,\n        },\n        connected: defaultDevice.connected,\n      });\n    } else {\n      sendResponse(res, true, {\n        config: {\n          ip: '192.168.1.100',\n          apiKey: null,\n          useHttps: false,\n        },\n        connected: false,\n      });\n    }\n  })\n);\n\n// ===========================================\n// WEBSOCKET STATUS ENDPOINT\n// ===========================================\n\napp.get(\n  '/api/websocket/status',\n  securityMiddleware.authenticate(jwtService),\n  securityMiddleware.requireRole('admin'),\n  asyncHandler(async (req: Request, res: Response) => {\n    const clients = webSocketService.getConnectedClients();\n    const clientCount = webSocketService.getClientCount();\n    \n    sendResponse(res, true, {\n      clientCount,\n      clients,\n    });\n  })\n);\n\n// ===========================================\n// HEALTH CHECK ENDPOINTS\n// ===========================================\n\napp.get('/health', (req: Request, res: Response) => {\n  sendResponse(res, true, {\n    status: 'healthy',\n    uptime: process.uptime(),\n    memory: process.memoryUsage(),\n    version: '2.0.0',\n  });\n});\n\napp.get('/ready', (req: Request, res: Response) => {\n  const ready = deviceManager && webSocketService;\n  \n  if (ready) {\n    sendResponse(res, true, { status: 'ready' });\n  } else {\n    sendResponse(res, false, { status: 'not ready' }, 'Service not ready', 503);\n  }\n});\n\n// ===========================================\n// STATIC FILES AND SPA SUPPORT\n// ===========================================\n\n// Serve main page\napp.get('/', (req: Request, res: Response) => {\n  res.sendFile(path.join(__dirname, '../public', 'index.html'));\n});\n\n// SPA fallback - serve index.html for all non-API routes\napp.get('*', (req: Request, res: Response) => {\n  if (req.path.startsWith('/api/')) {\n    sendResponse(res, false, null, 'API endpoint not found', 404);\n  } else {\n    res.sendFile(path.join(__dirname, '../public', 'index.html'));\n  }\n});\n\n// ===========================================\n// ERROR HANDLING\n// ===========================================\n\napp.use(errorHandler);\n\n// ===========================================\n// SERVER INITIALIZATION\n// ===========================================\n\nasync function initializeServer(): Promise<void> {\n  try {\n    console.log('🚀 Initializing Enhanced Biometric Server...');\n    \n    // Initialize device manager\n    await deviceManager.init();\n    \n    // Initialize WebSocket service\n    webSocketService = new WebSocketService(httpServer, jwtService);\n    \n    // Connect device manager events to WebSocket broadcasts\n    deviceManager.on('device:status_changed', ({ deviceId, status, config }) => {\n      webSocketService.broadcastDeviceStatus(deviceId, { ...status, config });\n    });\n    \n    deviceManager.on('device:health_updated', ({ deviceId, health }) => {\n      webSocketService.broadcastDeviceHealth(deviceId, health);\n    });\n    \n    deviceManager.on('bulk_operation:progress', ({ operationId, progress, operation }) => {\n      webSocketService.broadcastBulkOperationProgress(operation);\n    });\n    \n    deviceManager.on('device:connected', ({ deviceId, config }) => {\n      webSocketService.broadcastSystemAlert({\n        level: 'info',\n        title: 'Device Connected',\n        message: `Device ${config.name} is now online`,\n        deviceId,\n        branch: config.branch,\n      });\n    });\n    \n    deviceManager.on('device:connection_failed', ({ deviceId, error }) => {\n      webSocketService.broadcastSystemAlert({\n        level: 'error',\n        title: 'Device Connection Failed',\n        message: `Failed to connect to device ${deviceId}: ${error}`,\n        deviceId,\n      });\n    });\n    \n    console.log('✅ Server initialization complete');\n    \n  } catch (error) {\n    console.error('❌ Server initialization failed:', error);\n    process.exit(1);\n  }\n}\n\n// ===========================================\n// GRACEFUL SHUTDOWN\n// ===========================================\n\nprocess.on('SIGTERM', gracefulShutdown);\nprocess.on('SIGINT', gracefulShutdown);\n\nasync function gracefulShutdown(signal: string): Promise<void> {\n  console.log(`\\n🛑 Received ${signal}. Starting graceful shutdown...`);\n  \n  try {\n    // Stop accepting new connections\n    httpServer.close(async () => {\n      console.log('📡 HTTP server closed');\n      \n      // Shutdown services\n      if (webSocketService) {\n        await webSocketService.shutdown();\n      }\n      \n      if (deviceManager) {\n        await deviceManager.shutdown();\n      }\n      \n      console.log('✅ Graceful shutdown complete');\n      process.exit(0);\n    });\n    \n    // Force shutdown after 30 seconds\n    setTimeout(() => {\n      console.error('⚠️ Forced shutdown due to timeout');\n      process.exit(1);\n    }, 30000);\n    \n  } catch (error) {\n    console.error('❌ Error during shutdown:', error);\n    process.exit(1);\n  }\n}\n\n// ===========================================\n// START SERVER\n// ===========================================\n\nhttpServer.listen(PORT, async () => {\n  console.log(`🚀 Enhanced Multi-Device Biometric Server running on http://localhost:${PORT}`);\n  console.log(`📱 Features: Multi-device, WebSocket, RBAC, Audit logging, Health monitoring`);\n  console.log(`🌐 Branch-based device management enabled`);\n  \n  await initializeServer();\n});\n\nexport default app;
